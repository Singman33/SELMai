<IfModule mod_ssl.c>
# Port 443 - Site web statique
<VirtualHost *:443>
    ServerName selmai.fr
    ServerAdmin eric.delcamp@free.fr
    DocumentRoot /var/www/html

    SSLCertificateFile /etc/letsencrypt/live/selmai.fr/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/selmai.fr/privkey.pem
    Include /etc/letsencrypt/options-ssl-apache.conf

    # Security Headers
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "no-referrer-when-downgrade"
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"

    # Servir les fichiers statiques depuis /var/www/html
    <Directory /var/www/html>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>
</VirtualHost>

# Port 3000 - Application SELMai
<VirtualHost *:3000>
    ServerName selmai.fr
    ServerAdmin eric.delcamp@free.fr

    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/selmai.fr/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/selmai.fr/privkey.pem
    Include /etc/letsencrypt/options-ssl-apache.conf

    # Security Headers
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "no-referrer-when-downgrade"
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"

    # Compression
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css
        AddOutputFilterByType DEFLATE application/javascript application/json
        AddOutputFilterByType DEFLATE image/svg+xml
    </IfModule>

    # SELMai API proxy
    ProxyPass /api/ http://localhost:3001/api/
    ProxyPassReverse /api/ http://localhost:3001/api/

    # SELMai Health check
    ProxyPass /health http://localhost:3001/health
    ProxyPassReverse /health http://localhost:3001/health

    # SELMai Frontend proxy
    ProxyPass / http://localhost:8080/
    ProxyPassReverse / http://localhost:8080/

    # Proxy headers
    ProxyPreserveHost On
    RequestHeader set X-Forwarded-Proto "https"
    RequestHeader set X-Forwarded-Port "3000"
</VirtualHost>
</IfModule>

# vim: syntax=apache ts=4 sw=4 sts=4 sr noet

